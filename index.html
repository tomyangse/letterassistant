<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>老杨帮您来写信</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
        .tab-btn.active {
            border-color: #2563eb;
            color: #2563eb;
            font-weight: 600;
        }
    </style>
</head>

<body class="bg-gray-50">
    <div id="app" class="flex flex-col min-h-screen">
        <header class="relative text-white shadow-md bg-blue-800" style="background-image: url('https://github.com/tomyangse/letterassistant/blob/main/background.png?raw=true'); background-size: cover; background-position: center;">
            <div class="absolute inset-0 bg-blue-900/70"></div>
            <div class="relative container mx-auto px-4 py-8 md:py-12">
                <h1 class="text-4xl md:text-5xl font-bold text-center">老杨帮您来写信</h1>
                <p class="text-lg md:text-xl text-center mt-4 text-blue-100">一页一页上传，再也不怕弄错</p>
                <div class="mt-4 max-w-3xl mx-auto text-center text-sm text-blue-200 bg-black/20 p-3 rounded-lg flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    <span>老杨是一个人工智能AI机器人，您上传的任何信件，平台不会保存，而且保证您上传的信件只有老杨机器人可以看到。</span>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-8 flex-grow">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Upload Section -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-blue-600"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M12 18h-1a2 2 0 0 1-2-2v-1a2 2 0 0 1 2-2h1v5z"></path></svg>
                        上传信件
                    </h2>
                    <p class="text-gray-600 mb-6">请按照顺序，一页一页地上传</p>

                    <div id="upload-slots-container" class="space-y-4">
                        <!-- Slots will be generated by JS -->
                    </div>

                    <button id="analyze-btn"
                        class="w-full mt-6 bg-green-600 text-white px-4 py-4 rounded-lg hover:bg-green-700 transition-colors font-bold text-lg disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path></svg>
                        开始读信
                    </button>
                </div>

                <!-- Result Section -->
                <div id="result-section" class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="mr-3 text-blue-600">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                        </svg>
                        读信结果
                    </h2>
                    <p class="text-gray-600 mb-6">这是信里的内容和建议</p>

                    <div id="loading-spinner" class="flex justify-center items-center py-10 hidden">
                        <div class="spinner"></div>
                        <p class="ml-4 text-gray-700">老杨正在努力读信中...</p>
                    </div>
                    
                    <div id="analysis-prompt" class="text-center text-gray-500 p-8 border-2 border-dashed rounded-lg">
                        <p>上传信件后，</p>
                        <p>这里会显示信的内容。</p>
                    </div>

                    <div id="analysis-results" class="hidden">
                        <!-- Content Summary -->
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-gray-700">内容摘要</h3>
                            <p id="summary" class="bg-gray-100 p-4 rounded-lg text-gray-800"></p>
                        </div>

                        <!-- Key Information -->
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold mb-2 text-gray-700">关键信息</h3>
                            <ul id="key-info" class="space-y-2"></ul>
                        </div>

                        <!-- Action Items -->
                        <div id="action-items-section" class="mt-6 hidden">
                            <h3 class="text-lg font-semibold mb-2 text-gray-700">需要您回答的问题</h3>
                            <div id="action-items" class="space-y-4"></div>
                            <button id="generate-reply-btn"
                                class="w-full mt-6 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold disabled:bg-blue-300 disabled:cursor-not-allowed">生成回信</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reply Modal -->
            <div id="reply-modal"
                class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl transform transition-all max-h-[90vh] flex flex-col">
                    <div class="flex justify-between items-center p-5 border-b">
                        <h2 class="text-2xl font-bold text-gray-800">生成的回信</h2>
                        <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800">
                            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div id="modal-content" class="p-6 overflow-y-auto">
                        <div id="reply-loading" class="flex justify-center items-center py-10">
                             <div class="spinner"></div>
                            <p class="ml-4 text-gray-700">正在生成回信...</p>
                        </div>
                        <div id="reply-content-container" class="hidden">
                             <div class="border-b border-gray-200">
                                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                                    <button id="original-reply-tab" class="tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">原文回信</button>
                                    <button id="chinese-reply-tab" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm">中文翻译</button>
                                </nav>
                             </div>
                             <div class="mt-4">
                                <div id="original-reply-panel">
                                    <textarea id="original-reply-textarea" readonly class="w-full h-56 p-3 border border-gray-300 rounded-lg bg-gray-50 resize-none"></textarea>
                                </div>
                                <div id="chinese-reply-panel" class="hidden">
                                     <textarea id="chinese-reply-textarea" readonly class="w-full h-56 p-3 border border-gray-300 rounded-lg bg-gray-50 resize-none"></textarea>
                                </div>
                             </div>

                            <button id="copy-reply-btn"
                                class="mt-4 w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                <span id="copy-btn-text">复制原文内容</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="bg-white mt-12 py-6 border-t">
            <div class="container mx-auto px-4 text-center text-gray-600">
                <p>&copy; 2025 老杨帮您来写信. 版权所有.</p>
            </div>
        </footer>
    </div>


    <script type="module">
        const MAX_FILES = 5;
        const GENERATE_TEXT_API_URL = '/api/analyze';

        // DOM Elements
        const uploadSlotsContainer = document.getElementById('upload-slots-container');
        const analyzeBtn = document.getElementById('analyze-btn');
        const resultSection = document.getElementById('result-section');
        const loadingSpinner = document.getElementById('loading-spinner');
        const analysisPrompt = document.getElementById('analysis-prompt');
        const analysisResults = document.getElementById('analysis-results');
        const summaryEl = document.getElementById('summary');
        const keyInfoEl = document.getElementById('key-info');
        const actionItemsSection = document.getElementById('action-items-section');
        const actionItemsEl = document.getElementById('action-items');
        const generateReplyBtn = document.getElementById('generate-reply-btn');
        const replyModal = document.getElementById('reply-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const replyLoading = document.getElementById('reply-loading');
        const replyContentContainer = document.getElementById('reply-content-container');
        const copyReplyBtn = document.getElementById('copy-reply-btn');
        const copyBtnText = document.getElementById('copy-btn-text');
        const originalReplyTab = document.getElementById('original-reply-tab');
        const chineseReplyTab = document.getElementById('chinese-reply-tab');
        const originalReplyPanel = document.getElementById('original-reply-panel');
        const chineseReplyPanel = document.getElementById('chinese-reply-panel');
        const originalReplyTextarea = document.getElementById('original-reply-textarea');
        const chineseReplyTextarea = document.getElementById('chinese-reply-textarea');

        // State
        let uploadedFiles = new Array(MAX_FILES).fill(null);
        let originalLanguage = 'Unknown';

        // --- Event Listeners ---
        analyzeBtn.addEventListener('click', analyzeLetter);
        generateReplyBtn.addEventListener('click', handleGenerateReply);
        closeModalBtn.addEventListener('click', () => replyModal.classList.add('hidden'));
        copyReplyBtn.addEventListener('click', copyReplyToClipboard);
        originalReplyTab.addEventListener('click', () => switchTab('original'));
        chineseReplyTab.addEventListener('click', () => switchTab('chinese'));

        uploadSlotsContainer.addEventListener('click', (e) => {
            const uploadBtn = e.target.closest('.upload-btn');
            if (uploadBtn) {
                const index = uploadBtn.dataset.index;
                document.getElementById(`file-input-${index}`).click();
            }
        });

        // --- Core Functions ---

        /**
         * Renders the initial state of the UI, creating upload slots.
         */
        function initializeUI() {
            let slotsHTML = '';
            for (let i = 0; i < MAX_FILES; i++) {
                slotsHTML += `
                    <div class="upload-slot border border-gray-200 rounded-lg p-3">
                        <input type="file" id="file-input-${i}" class="hidden" accept="image/*" data-index="${i}">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0 bg-gray-200 text-gray-600 w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">${i + 1}</div>
                            <div id="file-info-${i}" class="flex-grow text-gray-500">未上传</div>
                            <button id="upload-btn-${i}" data-index="${i}" class="upload-btn bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 text-sm font-semibold">上传</button>
                        </div>
                    </div>
                `;
            }
            uploadSlotsContainer.innerHTML = slotsHTML;

            // Attach change listeners after creating the inputs
            for (let i = 0; i < MAX_FILES; i++) {
                document.getElementById(`file-input-${i}`).addEventListener('change', handleFileChange);
            }
            updateAnalyzeButtonState();
        }

        /**
         * Handles the file input change event for each slot.
         * @param {Event} e The change event object.
         */
        function handleFileChange(e) {
            const index = parseInt(e.target.dataset.index, 10);
            if (e.target.files.length > 0) {
                uploadedFiles[index] = e.target.files[0];
                renderSlot(index);
            }
        }
        
        /**
         * Renders a single upload slot based on its state.
         * @param {number} index The index of the slot to render.
         */
        function renderSlot(index) {
            const file = uploadedFiles[index];
            const infoEl = document.getElementById(`file-info-${index}`);
            const uploadBtn = document.getElementById(`upload-btn-${index}`);

            if (file) {
                infoEl.innerHTML = `
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-green-500 mr-2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        <span class="text-gray-800 font-medium text-sm truncate" title="${file.name}">${file.name}</span>
                    </div>
                `;
                uploadBtn.textContent = '更换';
                uploadBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                uploadBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
            }
            updateAnalyzeButtonState();
        }

        /**
         * Updates the enabled/disabled state of the "Analyze" button.
         */
        function updateAnalyzeButtonState() {
            const hasFiles = uploadedFiles.some(file => file !== null);
            analyzeBtn.disabled = !hasFiles;
        }

        /**
         * Analyzes the uploaded letter using the Gemini API.
         */
        async function analyzeLetter() {
            const filesToProcess = uploadedFiles.filter(file => file !== null);

            if (filesToProcess.length === 0) {
                alert("请至少上传一页信件！");
                return;
            }
            
            analysisPrompt.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            analysisResults.classList.add('hidden');
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = "正在读信...";

            try {
                const base64Promises = filesToProcess.map(file => fileToBase64(file));
                const base64DataArray = await Promise.all(base64Promises);
                const mimeType = filesToProcess[0].type;

                const systemPrompt = `你是一位极其严谨、注重细节的法律助理。你的首要任务是确保从信件中提取的信息 **完整无缺** 且 **绝对准确**。

请严格按照以下两步流程处理上传的信件图片：

**第一步：原始信息提取**
仔细阅读信件的每一部分，提取所有关键的、客观的事实信息点。这包括但不限于：
- 所有的人名、公司名或机构名
- 所有的日期和时间 (例如：截止日期、事件日期)
- 所有的金额、账号或具体数字
- 所有的地址、联系方式 (电话、邮箱)
- 所有明确的指令或要求 (例如：“请在X月X日前回复”、“需要提交XX文件”)

**第二步：生成结构化JSON**
根据第一步提取的信息，生成一个严格的JSON对象，包含以下字段：

1.  \`summary\`: (字符串) 用简体中文，**详细地** 概括信件的全部内容。**此摘要必须包含第一步中提取的所有关键信息点**，目标是完整性，而不是简洁性。请在生成后再次检查，确保没有遗漏任何细节。
2.  \`language\`: (字符串) 信件的原始语言 (例如, "Swedish", "English")。
3.  \`keyInfo\`: (字符串数组) 将第一步中提取的最重要的信息点，以清晰的列表形式呈现。每一个点都应该是具体的事实。
4.  \`actionItems\`: (对象数组) 如果信件要求收件人做任何事，请在这里列出。每个对象应包含 \`id\` 和 \`question\`。如果没有任何需要处理的事项，返回一个空数组 \`[]\`。

你的输出必须是完美的JSON格式。准确性和完整性是最高优先级。`;

                const contentParts = [{ text: "请将以下图片作为一封多页信件进行连续分析，并提供整合后的结果。" }];
                base64DataArray.forEach(data => {
                    contentParts.push({ inlineData: { mimeType, data } });
                });

                const payload = {
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    contents: [{ parts: contentParts }],
                    generationConfig: { responseMimeType: "application/json" }
                };
                
                const result = await fetchWithBackoff(payload);
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    const data = JSON.parse(text);
                    displayAnalysis(data);
                } else {
                    throw new Error("未能从API获取有效分析结果。");
                }

            } catch (error) {
                console.error("分析失败:", error);
                analysisResults.classList.remove('hidden');
                summaryEl.textContent = `抱歉，读信时出错了: ${error.message}`;
            } finally {
                loadingSpinner.classList.add('hidden');
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path></svg>开始读信';
            }
        }
        
        function displayAnalysis(data) {
            analysisResults.classList.remove('hidden');
            originalLanguage = data.language;
            summaryEl.textContent = data.summary;

            keyInfoEl.innerHTML = data.keyInfo.map(info =>
                `<li class="flex items-start bg-blue-50 text-blue-800 p-3 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 mt-1 flex-shrink-0"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg><span>${info}</span></li>`
            ).join('');

            if (data.actionItems && data.actionItems.length > 0) {
                actionItemsEl.innerHTML = data.actionItems.map(item =>
                    `<div class="bg-gray-50 p-4 rounded-lg border"><label for="${item.id}" class="block font-medium text-gray-800 mb-2">${item.question}</label><input type="text" id="${item.id}" name="${item.id}" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="请在此输入您的回答..."></div>`
                ).join('');
                actionItemsSection.classList.remove('hidden');
            } else {
                 actionItemsSection.classList.add('hidden');
            }
        }
        
        async function handleGenerateReply() {
             generateReplyBtn.disabled = true;
             generateReplyBtn.textContent = '正在生成...';
             replyModal.classList.remove('hidden');
             replyLoading.classList.remove('hidden');
             replyContentContainer.classList.add('hidden');
             switchTab('original');

             const userAnswers = {};
             actionItemsEl.querySelectorAll('input[type="text"]').forEach(input => {
                userAnswers[input.id] = input.value;
             });

             try {
                const systemPrompt = `你是一位专业的行政助理。你的任务是根据用户的回答，起草一封专业、礼貌的回信。
- **背景**: 用户收到了一封${originalLanguage}信件，信件的摘要是：“${summaryEl.textContent}”。
- **用户提供的回复信息**: ${JSON.stringify(userAnswers)}
- **任务**: 
  1. 生成一个包含两种语言回信的JSON对象。
  2. 键 "originalReply" 的值是用${originalLanguage}写的回信。
  3. 键 "chineseReply" 的值是 "originalReply" 的简体中文翻译。
  4. 严格返回JSON格式。`;
                
                const payload = {
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    contents: [{ parts: [{ text: "请帮我生成回信。" }] }],
                    generationConfig: { responseMimeType: "application/json" }
                };

                const result = await fetchWithBackoff(payload);
                const replyText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (replyText) {
                    const replies = JSON.parse(replyText);
                    originalReplyTextarea.value = replies.originalReply;
                    chineseReplyTextarea.value = replies.chineseReply;
                    originalReplyTab.textContent = `${originalLanguage}回信`;
                    copyBtnText.textContent = `复制${originalLanguage}内容`;
                } else {
                    throw new Error("未能从API获取有效的回信内容。");
                }

             } catch (error) {
                 console.error("生成回信失败:", error);
                 originalReplyTextarea.value = `抱歉，生成回信时出错：${error.message}`;
                 chineseReplyTextarea.value = `抱歉，生成回信时出错：${error.message}`;
             } finally {
                 replyLoading.classList.add('hidden');
                 replyContentContainer.classList.remove('hidden');
                 generateReplyBtn.disabled = false;
                 generateReplyBtn.textContent = '生成回信';
             }
        }

        function switchTab(tabName) {
            if (tabName === 'original') {
                originalReplyTab.classList.add('active');
                chineseReplyTab.classList.remove('active');
                originalReplyPanel.classList.remove('hidden');
                chineseReplyPanel.classList.add('hidden');
                copyBtnText.textContent = `复制${originalLanguage}内容`;
            } else {
                chineseReplyTab.classList.add('active');
                originalReplyTab.classList.remove('active');
                chineseReplyPanel.classList.remove('hidden');
                originalReplyPanel.classList.add('hidden');
                copyBtnText.textContent = '复制中文内容';
            }
        }
        
        function copyReplyToClipboard() {
            const textToCopy = !originalReplyPanel.classList.contains('hidden')
                ? originalReplyTextarea.value
                : chineseReplyTextarea.value;
            
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                const successful = document.execCommand('copy');
                const originalBtnText = copyBtnText.textContent;
                copyBtnText.textContent = successful ? '已复制!' : '复制失败';
                setTimeout(() => { copyBtnText.textContent = originalBtnText; }, 2000);
            } catch (err) {
                 console.error('Fallback: Oops, unable to copy', err);
            } finally {
                document.body.removeChild(tempTextArea);
            }
        }

        // --- Utility Functions ---
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }
        
        async function fetchWithBackoff(payload, maxRetries = 5) {
            let attempt = 0;
            let delay = 1000;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(GENERATE_TEXT_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    if (response.ok) return await response.json();
                    if (response.status === 429) { // Rate limit
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                        attempt++;
                    } else {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${response.status} - ${errorData.error || response.statusText}`);
                    }
                } catch (error) {
                     if (attempt >= maxRetries -1) throw error;
                     await new Promise(res => setTimeout(res, delay));
                     delay *= 2;
                     attempt++;
                }
            }
            throw new Error("API request failed after multiple retries.");
        }
        
        // --- Initial setup ---
        initializeUI();

    </script>
</body>

</html>



